-
  I first create a warehouse with pick-pack-ship and reception in 2 step
-
  !record {model: stock.warehouse, id: wh_pps}:
    name: WareHouse PickPackShip 
    code: whpps
    reception_steps: 'two_steps'
    delivery_steps: 'pick_pack_ship' 
-
  Next I create a new product in this warehouse
-
  !record {model: product.product, id: product_mto}:
    name: "My MTO Product"
    type: product
    uom_id: product.product_uom_unit
    uom_po_id: product.product_uom_unit
    seller_ids:                                                                                                                         
      - delay: 1
        name: base.res_partner_2
        min_qty: 2.0
        qty: 10.0
-
  Set routes on product to be MTO
-
 !python {model: product.product}: |
    route_warehouse0_buy = self.pool.get('stock.warehouse').browse(cr, uid, ref('stock.warehouse0')).buy_pull_id.route_id.id 
    route_warehouse0_mto = self.pool.get('stock.warehouse').browse(cr, uid, ref('stock.warehouse0')).mto_pull_id.route_id.id 
    self.write(cr, uid, ref('product_mto'), { 'route_ids': [(6, 0, [route_warehouse0_mto,route_warehouse0_buy])]}, context=context )       
-
  Create a sales order with a line of 5 "My MTO Product", with route_id Buy.
- 
  !record {model: sale.order, id: sale_order_product_mto}:
    partner_id: base.res_partner_3
    note: Create Sales order
    warehouse_id: wh_pps
    order_line:
      - product_id: product_mto
        product_uom_qty: 5.00
-
    !python {model: sale.order.line}: |
        route_warehouse0_buy = self.pool.get('stock.warehouse').browse(cr, uid, ref('stock.warehouse0')).buy_pull_id.route_id.id 
        order = self.pool.get('sale.order').browse(cr, uid, ref('sale_order_product_mto'))
        line_ids = [x.id for x in order.order_line]
        self.write(cr, uid, line_ids, {'route_id': route_warehouse0_buy})
- 
  Confirm sales order
- 
  !workflow {model: sale.order, action: order_confirm, ref: sale_order_product_mto}
- 
  Check the propagation when we cancel the main procurement 
    * Retrieve related procurements and check that there are all running
    * Check that Purchase order is well created
    * Cancel the main procurement
    * Check that all procurements related and the purchase order are well cancelled   
-
  !python {model: procurement.order}: |
    # Retrieve related procu
    so = self.pool.get('sale.order').browse(cr, uid, ref('sale_order_product_mto'))
    procu_ids = self.search(cr, uid, [('group_id.name', '=', so.name)])
    assert len(procu_ids)>0, 'None procu found for so %s (%d)' %(so.name,so.id)
    
    # Check that all procurement are running 
    for procu in self.browse(cr,uid,procu_ids,context=context):
        assert procu.state == u'running', 'Procu %d should be running and is in state : %s!' %(procu.id, procu.state)
    
    # Check that one or more PO                                                                                                          
    purchase_ids = [proc.purchase_line_id.order_id for proc in self.browse(cr, uid, procu_ids) if proc.purchase_line_id]
    assert len(purchase_ids) > 0, 'No purchase order find !'
    
    # Cancel the main procurement
    main_procu_id = self.search(cr, uid, [('origin', '=', so.name)])
    assert len(main_procu_id) == 1, 'Main procurement not identified !'
    self.cancel(cr, uid, main_procu_id, context=context)    
    assert self.browse(cr, uid, main_procu_id[0]).state == u'cancel', 'Main procurement is not cancelled !!!'
    
    # Check that all procurements related is cancelled    
    for procu in self.browse(cr, uid, procu_ids, context=context):
        assert procu.state == u'cancel', 'Procu %d should be cancelled and is in state : %s!' %(procu.id, procu.state)

    # Check that the purchase order is cancelled                                                                                        
    for po in self.pool.get('purchase.order').browse(cr, uid, [po.id for po in purchase_ids], context=context):
        assert po.state == u'cancel', 'Purchase %d should be cancelled and is in state : %s!' %(po.id, po.state)  
