<!doctype html>
<html>
<head>
    <script src="http://code.jquery.com/jquery-1.5.1.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/qunit/git/qunit.css" type="text/css" media="screen"/>
    <script type="text/javascript" src="http://code.jquery.com/qunit/git/qunit.js"></script>

    <script type="text/javascript" src="qweb.js"></script>

    <script>
        function trim(s) {
            return s.replace(/(^\s+|\s+$)/g, '');
        }
        function render(template, context) {
            return trim(QWeb.render(template, context));
        }
        $(document).ready(function() {
            module("Basic output tests", {
                setup: function () {
                    QWeb.add_template('qweb-test-output.xml');
                },
                teardown: function () {
                    QWeb.templates = [];
                    QWeb.tag = {};
                    QWeb.att = {};
                }
            });

            test("Basic escaped output", function () {
                equals(render('esc-literal', {}), "ok", "Render a literal string");
                equals(render('esc-variable', {ok: 'ok'}), "ok", "Render a string variable");
                equals(render('esc-toescape', {ok: '<ok>'}), "&lt;ok&gt;", "Render a string with data to escape");
            });
            test("Formatted escaped output", function () {
                equals(render('escf-noformat-literal', {}), "ok", "Render a literal string");
                equals(render('escf-simpleformat-variable', {value: 'ok'}), "ok",
                        "Only render an interpolated variable");
                equals(render('escf-format-variable', {value: 'ok'}), "[ok]",
                        "Actually formatted variable");
                equals(render('escf-format-variable-with-escapes', {value: '<ok>'}), '[&lt;ok&gt;]',
                        "Render a formatted string with data to escape");
            });
            test("Basic unescaped output", function () {
                equals(render('raw-literal', {}), "ok", "Render a literal string");
                equals(render('raw-variable', {ok: 'ok'}), "ok", "Render a string variable");
                equals(render('raw-notescaped', {ok: '<ok>'}), "<ok>", "Render a string with data not escaped");
            });
            test("Formatted unescaped output", function () {
                equals(render('rawf-noformat-literal', {}), "ok", "Render a literal string");
                equals(render('rawf-simpleformat-variable', {value: 'ok'}), "ok",
                        "Only render an interpolated variable");
                equals(render('rawf-format-variable', {value: 'ok'}), "[ok]",
                        "Actually formatted variable");
                equals(render('rawf-format-variable-notescaped', {value: '<ok>'}), '[<ok>]',
                        "Render a formatted string with data not escaped");
            });

            module("Context-setting tests", {
                setup: function () {
                    QWeb.add_template('qweb-test-set.xml');
                },
                teardown: function () {
                    QWeb.templates = [];
                    QWeb.tag = {};
                    QWeb.att = {};
                }
            });
            test("Set literal value", function () {
                equals(render('set-from-attribute-literal', {}), "ok",
                        "Set a literal value via @t-value");
                equals(render('set-from-body-literal', {}), "ok",
                        "Set a literal value via @t-set body");
            });
            test("Set value looked up from context", function () {
                equals(render('set-from-attribute-lookup', {value: 'ok'}), "ok",
                        "Set a value looked up in context via @t-value");
                equals(render('set-from-body-lookup', {value: 'ok'}), 'ok',
                        "Set a value looked up in context via @t-set body and @t-esc");
            });

            module("Conditionals", {
                setup: function () {
                    QWeb.add_template('qweb-test-conditionals.xml');
                },
                teardown: function () {
                    QWeb.templates = [];
                    QWeb.tag = {};
                    QWeb.att = {};
                }
            });
            test('Basic (single boolean) conditionals', function () {
                equals(render('literal-conditional', {}), 'ok',
                    "Test on a literal value");
                equals(render('boolean-value-conditional', {value: true}), 'ok',
                    "Test on a truthy variable value");
                equals(render('boolean-value-conditional-false', {value: false}), '',
                    "Test on a falsy variable value");
            });
            test('Boolean expressions in conditionals', function () {
                equals(render('negify', {}), 'ok',
                    "Negative");
                equals(render('equality', {}), 'ok',
                    "Equality");
                equals(render('difference', {}), 'ok',
                    "Difference");
                equals(render('and', {}), 'ok',
                    "Boolean and");
                equals(render('and-js', {}), 'ok',
                    "Boolean and via manually escaped JS operator");
                equals(render('or', {}), 'ok',
                    "Boolean or");
                equals(render('or-js', {}), 'ok',
                    "Boolean or using JS operator");
            });
            test('Comparison boolean tests in conditionals', function () {
                equals(render('greater', {}), 'ok',
                    "Greater");
                equals(render('greater-js', {}), 'ok',
                    "Greater, JS operator");
                equals(render('lower', {}), 'ok',
                    "Lower");
                equals(render('lower-js', {}), 'ok',
                    "Lower, JS operator");
                equals(render('greater-or-equal', {}), 'ok',
                    "Greater or Equal");
                equals(render('greater-or-equal-js', {}), 'ok',
                    "Greater or Equal, JS operator");
                equals(render('lower-or-equal', {}), 'ok',
                    "Lower or Equal");
                equals(render('lower-or-equal-js', {}), 'ok',
                    "Lower or Equal, JS operator");
            });

            module("Attributes manipulation", {
                setup: function () {
                    QWeb.add_template('qweb-test-attributes.xml');
                },
                teardown: function () {
                    QWeb.templates = [];
                    QWeb.tag = {};
                    QWeb.att = {};
                }
            });
            test('Fixed-name attributes', function () {
                equals(render('fixed-literal', {}), '<div foo="bar"/>',
                    "Fixed name and literal attribute value");
                equals(render('fixed-variable', {value: 'ok'}), '<div foo="ok"/>',
                    "Fixed name and variable attribute value");
            });
            test('Tuple-based attributes', function () {
                equals(render('tuple-literal', {}), '<div foo="bar"/>',
                    "Tuple-based literal attributes");
                equals(render('tuple-variable', {att: ['foo', 'bar']}), '<div foo="bar"/>',
                    "Tuple-based variable attributes");
            });
            test('Fixed name, formatted value attributes', function () {
                equals(render('format-literal', {}), '<div foo="bar"/>',
                    "Literal format");
                equals(render('format-value', {value:'a'}), '<div foo="bar"/>',
                    "Valued format");
            });

            module("Template calling (including)", {
                setup: function () {
                    QWeb.add_template('qweb-test-call.xml');
                },
                teardown: function () {
                    QWeb.templates = [];
                    QWeb.tag = {};
                    QWeb.att = {};
                }
            });
            test('Trivial call invocation', function () {
                equals(render('basic-caller', {}), 'ok',
                    "Direct call of a second template");
            });
            test('Call invocation with body', function () {
                equals(render('with-unused-body', {}), 'ok',
                    "Call of a second template with body unused");
                equals(render('with-unused-setbody', {}), 'ok',
                    "Call of a second template with body directives unused");
            });
            test('Call invocation with body (used by callee)', function () {
                equals(render('with-used-body', {}), 'ok',
                    "Call of a second template with body used");
            });
            test('Call invocation with parameters set (in body)', function () {
                equals(render('with-used-setbody', {}), 'ok',
                    "Call of a second template with parameters");
            });
            test('Call invocation in-context (via import)', function () {
                equals(render('in-context-import', {}), 'ok',
                    "Call with t-import (calls in current context)");
            });

            module("Trim", {
                setup: function () {
                    QWeb.add_template('qweb-test-trim.xml');
                },
                teardown: function () {
                    QWeb.templates = [];
                    QWeb.tag = {};
                    QWeb.att = {};
                }
            });
            test('Trim content', function () {
                equals(QWeb.render('trim-content-both', {}), 'ok',
                    "Trims before and after content");
                equals(QWeb.render('trim-content-before', {}), 'ok ',
                    "Trims before content");
                equals(QWeb.render('trim-content-after', {}), ' ok',
                    "Trims after content");
                raises(function () {QWeb.render('trim-content-unknown', {});},
                    "Trims with an unknown mode");
            });
            test('Trim content *and* children', function () {
                equals(QWeb.render('trim-children-text', {}), 'o k',
                    "Trims text children");
                equals(QWeb.render('trim-children-elements', {}), '<foo/><bar/>',
                    "Full trim");
                equals(QWeb.render('trim-mixed-children', {}), '[<foo/>]',
                    "Trims mixed content of text and elements");
                equals(QWeb.render('trim-children-left', {}), '<foo/><bar/> ',
                    "Trims children and left of content");
                equals(QWeb.render('trim-children-right', {}), ' <foo/><bar/>',
                    "Trims children and right of content");
            });
        });
    </script>

</head>
<body>
<h1 id="qunit-header">QUnit example</h1>

<h2 id="qunit-banner"></h2>

<div id="qunit-testrunner-toolbar"></div>
<h2 id="qunit-userAgent"></h2>
<ol id="qunit-tests"></ol>
<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
